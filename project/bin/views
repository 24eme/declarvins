CONFIGFILE=config/databases.yml
TMPFILE=/tmp/couchdb.$$.tmp

url=$(grep 'dsn:' $CONFIGFILE | sed 's/.*dsn: //' | sed 's/[^\/]*$//')
base=$(grep 'dbname:' $CONFIGFILE | sed 's/.*dbname: //' | sed 's/\W*$//')
COUCHDBURL=$url$base

design=douane
curl -s -X DELETE "$COUCHDBURL/_design/$design?rev=$(curl --stderr /dev/null $COUCHDBURL/_design/$design | sed 's/.*_rev":"//' | sed 's/",".*//' 2> /dev/null)" > /dev/null 2>&1

cat <<EOF > $TMPFILE
{
   "_id": "_design/douane",
   "language": "javascript",
   "views": {
       "all": {
           "map": "function(doc) {\n  if (doc.type == \"Douane\")\n  emit(doc.id, null);\n}"
       }
   }
}
EOF

curl -s -X PUT -d "@$TMPFILE" $COUCHDBURL/_design/$design

curl -s $COUCHDBURL/_design/$design/_view/all > /dev/null &
sleep 1
kill %1

design=edi
curl -s -X DELETE "$COUCHDBURL/_design/$design?rev=$(curl --stderr /dev/null $COUCHDBURL/_design/$design | sed 's/.*_rev":"//' | sed 's/",".*//' 2> /dev/null)" > /dev/null 2>&1

cat <<EOF > $TMPFILE
{
   "_id": "_design/edi",
   "language": "javascript",
   "views": {
       "all": {
           "map": "function(doc) {\n  if (doc.type == \"Edi\")\n  emit(doc.id, null);\n}"
       }
   }
}
EOF

curl -s -X PUT -d "@$TMPFILE" $COUCHDBURL/_design/$design

curl -s $COUCHDBURL/_design/$design/_view/all > /dev/null &
sleep 1
kill %1

design=drm
curl -s -X DELETE "$COUCHDBURL/_design/$design?rev=$(curl --stderr /dev/null $COUCHDBURL/_design/$design | sed 's/.*_rev":"//' | sed 's/",".*//' 2> /dev/null)" > /dev/null 2>&1

cat <<EOF > $TMPFILE
{
   "_id": "_design/drm",
   "language": "javascript",
   "views": {
       "all": {
           "map": "function(doc) {\n  if (doc.type == \"DRM\") {\n  rect = null ; if (doc.rectificative) rect = doc.rectificative;\n  emit([doc.identifiant, (doc.campagne).substring(0, 4), (doc.campagne).substring(5, 7), rect, doc.valide.date_saisie, doc.douane.envoi, doc.douane.accuse, doc._id], 1);\n }\n}",
           "reduce": "function (keys, values, rereduce) {\n     return sum(values);\n}"
       },
       "date": {
          "map": "function(doc) { if (doc.type == \"DRM\" && doc.valide.date_saisie) { rect = null ; if (doc.rectificative) rect = doc.rectificative; for(inter in doc.interpros) { emit([doc.interpros[inter], doc.valide.date_saisie, doc._id], 1);  }  } }"
       },
       "produits": {
           "map": "function(doc) {\n  if (doc.type == \"DRM\") {\nfor (certification in doc.declaration.certifications) {\n        for (appellation in doc.declaration.certifications[certification].appellations) {\n            for(lieu in doc.declaration.certifications[certification].appellations[appellation].lieux) {\n                for(couleur in doc.declaration.certifications[certification].appellations[appellation].lieux[lieu].couleurs) {\n                    for(cepage in doc.declaration.certifications[certification].appellations[appellation].lieux[lieu].couleurs[couleur].cepages) {    \n                        for(millesime in doc.declaration.certifications[certification].appellations[appellation].lieux[lieu].couleurs[couleur].cepages[cepage].millesimes) {\n                            var hash = \"declaration/certifications/\"+certification+\"/appellations/\"+appellation+\"/lieux/\"+lieu+\"/couleurs/\"+couleur+\"/cepages/\"+cepage+\"/millesimes/\"+millesime;\n\t\t\t    emit([\"produit\", hash], 1);\n                        } // Boucle millesime\n                    } // Boucle cepage\n                } // Boucle couleur\n            } // Boucle lieu\n        } // Boucle appellation\n    } // Boucle certification\n }\n}"
       }
}
}
EOF

curl -s -X PUT -d "@$TMPFILE" $COUCHDBURL/_design/$design

curl -s $COUCHDBURL/_design/$design/_view/all > /dev/null &
sleep 1
kill %1

design=vrac
curl -s -X DELETE "$COUCHDBURL/_design/$design?rev=$(curl --stderr /dev/null $COUCHDBURL/_design/$design | sed 's/.*_rev":"//' | sed 's/",".*//' 2> /dev/null)" > /dev/null 2>&1

cat <<EOF > $TMPFILE
{
   "_id": "_design/vrac",
   "language": "javascript",
   "views": {
       "all": {
           "map": "function(doc) {\n\tif (doc.type == 'Vrac')\n  \t\temit([doc.etablissement, doc.numero, doc.actif, doc.annee, doc.mois, doc.date_creation, doc.produit, doc.volume_promis, doc.acheteur.nom, doc.courtier.nom], 1);\n}"
       }
    }
}
EOF

curl -s -X PUT -d "@$TMPFILE" $COUCHDBURL/_design/$design

design=configuration
curl -s -X DELETE "$COUCHDBURL/_design/$design?rev=$(curl --stderr /dev/null $COUCHDBURL/_design/$design | sed 's/.*_rev":"//' | sed 's/",".*//' 2> /dev/null)" > /dev/null 2>&1

cat <<EOF > $TMPFILE
{
   "language": "javascript",
   "views": {
       "produits": {
           "map": "function(doc) {\n    if (doc.type != \"Configuration\")\n    return ;\n    var inter = new Array();\n    var dep = new Array(new Array(\"\"));\n    var libelles = new Array();\n    var codes = new Array();\n\n    for (c in doc.declaration.certifications) {\n        var interpros = new Array();\n        for(interpro_key in doc.declaration.certifications[c].interpro) {\n            interpros.push(interpro_key);\n            for(label_index in doc.declaration.certifications[c].interpro[interpro_key].labels) {\n                label_key = doc.declaration.certifications[c].interpro[interpro_key].labels[label_index];\n                emit([\"labels\", interpro_key, \"\", c, label_key], doc.labels[label_key]);\n            }\n        }\n        inter.unshift(interpros);\n        dep.unshift(doc.declaration.certifications[c].departements);\n        libelles.push(doc.declaration.certifications[c].libelle);\n        codes.push(doc.declaration.certifications[c].code);\n        for (g in doc.declaration.certifications[c].genres) {\n            var interpros = new Array();\n            for(interpro_key in doc.declaration.certifications[c].genres[g].interpro) {\n                interpros.push(interpro_key);\n            }\n            inter.unshift(interpros);\n            dep.unshift(doc.declaration.certifications[c].genres[g].departements);\n            libelles.push(doc.declaration.certifications[c].genres[g].libelle);\n            codes.push(doc.declaration.certifications[c].genres[g].code);\n            for (a in doc.declaration.certifications[c].genres[g].appellations) {\n                var interpros = new Array();\n                for(interpro_key in doc.declaration.certifications[c].genres[g].appellations[a].interpro) {\n                    interpros.push(interpro_key);\n                }\n                inter.unshift(interpros);\n                dep.unshift(doc.declaration.certifications[c].genres[g].appellations[a].departements);\n                libelles.push(doc.declaration.certifications[c].genres[g].appellations[a].libelle);\n                codes.push(doc.declaration.certifications[c].genres[g].appellations[a].code);\n                for (m in doc.declaration.certifications[c].genres[g].appellations[a].mentions) {\n                \tdep.unshift(doc.declaration.certifications[c].genres[g].appellations[a].mentions[m].departements);\n                    libelles.push(doc.declaration.certifications[c].genres[g].appellations[a].mentions[m].libelle);\n                    codes.push(doc.declaration.certifications[c].genres[g].appellations[a].mentions[m].code);\n                \tfor(l in doc.declaration.certifications[c].genres[g].appellations[a].mentions[m].lieux) {\n\t                    dep.unshift(doc.declaration.certifications[c].genres[g].appellations[a].mentions[m].lieux[l].departements);\n\t                    libelles.push(doc.declaration.certifications[c].genres[g].appellations[a].mentions[m].lieux[l].libelle);\n\t                    codes.push(doc.declaration.certifications[c].genres[g].appellations[a].mentions[m].lieux[l].code);\n\t                    var libes = libelles.slice();\n\t                    var hash = \"declaration/certifications/\"+c+\"/genres/\"+g+\"/appellations/\"+a+\"/mentions/\"+m+\"/lieux/\"+l;\n\t                    for(i in inter) {\n\t                        if (inter[i].length > 0) {\n\t                            for(array_intepro_key in inter) {\n\t                                for(array_dep_key in dep) {\n\t                                    if (dep[array_dep_key].length > 0) {\n\t                                        for(d in dep[array_dep_key]) {\n\t                                            emit([\"lieux\", inter[i][array_intepro_key], dep[array_dep_key][d], c, hash, codes.join('')], libes);\n\t                                        }\n\t                                        break;\n\t                                    }\n\t                                }\n\t                                break;\n\t                            }\n\t                            break;\n\t                        }\n\t                    }\n\t                    for(co in doc.declaration.certifications[c].genres[g].appellations[a].mentions[m].lieux[l].couleurs) {\n\t                        libelles.push(doc.declaration.certifications[c].genres[g].appellations[a].mentions[m].lieux[l].couleurs[co].libelle);\n\t                        codes.push(doc.declaration.certifications[c].genres[g].appellations[a].mentions[m].lieux[l].couleurs[co].code);\n\t                        for(ce in doc.declaration.certifications[c].genres[g].appellations[a].mentions[m].lieux[l].couleurs[co].cepages) {\n\t                            libelles.push(doc.declaration.certifications[c].genres[g].appellations[a].mentions[m].lieux[l].couleurs[co].cepages[ce].libelle);\n\t                            codes.push(doc.declaration.certifications[c].genres[g].appellations[a].mentions[m].lieux[l].couleurs[co].cepages[ce].code);        \n\t                            var libes = libelles.slice();\n\t                            var hash = \"declaration/certifications/\"+c+\"/genres/\"+g+\"/appellations/\"+a+\"/mentions/\"+m+\"/lieux/\"+l+\"/couleurs/\"+co+\"/cepages/\"+ce;\n\t                            var hash_lieu = \"declaration/certifications/\"+c+\"/genres/\"+g+\"/appellations/\"+a+\"/mentions/\"+m+\"/lieux/\"+l;\n\t                            for(i in inter) {\n\t                                if (inter[i].length > 0) {\n\t                                    for(array_intepro_key in inter) {\n\t                                        for(array_dep_key in dep) {\n\t                                            if (dep[array_dep_key].length > 0) {\n\t                                                for(d in dep[array_dep_key]) {\n\t                                                    emit([\"produits\", inter[i][array_intepro_key], dep[array_dep_key][d], c, hash_lieu, hash, codes.join('')], libes);\n\t                                                }\n\t                                                break;\n\t                                            }\n\t                                        }\n\t                                        break;\n\t                                    }\n\t                                    break;\n\t                                }\n\t                            }\n\t                            libelles.splice(libelles.length-1, 1);\n\t                            codes.splice(codes.length-1, 1);\n\t                        }\n\t                        libelles.splice(libelles.length-1, 1);\n\t                        codes.splice(codes.length-1, 1);\n\t                    }\n\t                    dep.splice(0, 1);\n\t                    libelles.splice(libelles.length-1, 1);\n\t                    codes.splice(codes.length-1, 1);\n\t                }\n                    dep.splice(0, 1);\n                    libelles.splice(libelles.length-1, 1);\n                    codes.splice(codes.length-1, 1);\n            \t}\n                inter.splice(0,1);\n                dep.splice(0, 1);\n                libelles.splice(libelles.length-1, 1);\n                codes.splice(codes.length-1, 1);\n            }\n            inter.splice(0, 1);\n            dep.splice(0, 1);\n            libelles.splice(libelles.length-1, 1);\n            codes.splice(codes.length-1, 1);\n        }\n        inter.splice(0, 1);\n        dep.splice(0, 1);\n        libelles.splice(libelles.length-1, 1);\n        codes.splice(codes.length-1, 1);\n    }\n}\n",
           "reduce": "function (keys, values, rereduce) {\n     return values.length;\n}"
        },
       "produits_admin": {
           "map": "function(doc) \n{\n    if (doc.type != \"Configuration\")\n    \treturn ;\n    var nb = 0;\n    for (certification in doc.declaration.certifications) \n    {\n    \tvar certificationLibelle = doc.declaration.certifications[certification].libelle;\n    \tvar departementsCertification = doc.declaration.certifications[certification].departements;\n    \tvar detailCertification = doc.declaration.certifications[certification].detail;\n    \tvar interprosCertification = new Array();\n    \tfor (i in doc.declaration.certifications[certification].interpro)\n    \t{\n    \t\tinterprosCertification[i] = new Array();\n    \t\tinterprosCertification[i][\"label\"] = doc.declaration.certifications[certification].interpro[i].labels;\n    \t\tinterprosCertification[i][\"douane\"] = doc.declaration.certifications[certification].interpro[i].droits.douane.pop();\n    \t\tinterprosCertification[i][\"cvo\"] = doc.declaration.certifications[certification].interpro[i].droits.cvo.pop();\n    \t}\n    \t\n    \tfor (genre in doc.declaration.certifications[certification].genres)\n    \t{\n    \t\tvar genreLibelle = doc.declaration.certifications[certification].genres[genre].libelle;\n    \t\tvar departementsGenre = doc.declaration.certifications[certification].genres[genre].departements;\n    \t\tvar detailGenre = detailCertification;\n    \t\tvar interprosGenre = interprosCertification;\n    \t\tif (doc.declaration.certifications[certification].genres[genre].hasOwnProperty(\"interpro\"))\n    \t\t{\n    \t\t\tnb = 0;\n    \t\t\tfor (item in doc.declaration.certifications[certification].genres[genre].interpro) {\n    \t\t\t\tnb = nb + 1;\n    \t\t\t}\n    \t\t\tif (nb > 0) {\n\t    \t\t\tinterprosGenre = new Array();\n\t\t        \tfor (i in doc.declaration.certifications[certification].genres[genre].interpro)\n\t\t        \t{\n\t\t        \t\tinterprosGenre[i] = new Array();\n\t\t        \t\tinterprosGenre[i][\"label\"] = new Array();\n\t\t        \t\tinterprosGenre[i][\"douane\"] = new Array();\n\t\t        \t\tinterprosGenre[i][\"cvo\"] = new Array();\n\t\t        \t\tif (interprosCertification.hasOwnProperty(i))\n\t\t        \t\t{\n\t\t        \t\t\tinterprosGenre[i][\"label\"] = interprosCertification[i][\"label\"];\n\t\t        \t\t\tinterprosGenre[i][\"douane\"] = interprosCertification[i][\"douane\"];\n\t\t        \t\t\tinterprosGenre[i][\"cvo\"] = interprosCertification[i][\"cvo\"];\n\t\t        \t\t}\n\t\t        \t\tif (doc.declaration.certifications[certification].genres[genre].interpro[i].labels.length > 0)\n\t\t        \t\t{\n\t\t        \t\t\tinterprosGenre[i][\"label\"] = doc.declaration.certifications[certification].genres[genre].interpro[i].labels;\n\t\t        \t\t}\n\t\t        \t\tif (doc.declaration.certifications[certification].genres[genre].interpro[i].hasOwnProperty(\"droits\"))\n\t\t        \t\t{\n\t\t        \t\t\tif (doc.declaration.certifications[certification].genres[genre].interpro[i].droits.hasOwnProperty(\"douane\") && doc.declaration.certifications[certification].genres[genre].interpro[i].droits.douane.length > 0) \n\t\t        \t\t\t\tinterprosGenre[i][\"douane\"] = doc.declaration.certifications[certification].genres[genre].interpro[i].droits.douane.pop();\n\t\t        \t\t\tif (doc.declaration.certifications[certification].genres[genre].interpro[i].droits.hasOwnProperty(\"cvo\") && doc.declaration.certifications[certification].genres[genre].interpro[i].droits.cvo.length > 0)\n\t\t        \t\t\t\tinterprosGenre[i][\"cvo\"] = doc.declaration.certifications[certification].genres[genre].interpro[i].droits.cvo.pop();\n\t\t        \t\t}\n\t\t        \t}\n    \t\t\t}\n    \t\t}\n    \t\tif (departementsGenre.length == 0)\n    \t\t{\n    \t\t\tdepartementsGenre = departementsCertification;\n    \t\t}\n    \t\tif (doc.declaration.certifications[certification].genres[genre].hasOwnProperty('detail'))\n    \t\t{\n    \t\t\tdetailGenre = doc.declaration.certifications[certification].genres[genre].detail;\n    \t\t}\n    \t\tfor (appellation in doc.declaration.certifications[certification].genres[genre].appellations) \n    \t\t{\n    \t\t\tvar appellationLibelle = doc.declaration.certifications[certification].genres[genre].appellations[appellation].libelle;\n        \t\tvar departementsAppellation = doc.declaration.certifications[certification].genres[genre].appellations[appellation].departements;\n        \t\tvar detailAppellation = detailGenre;\n        \t\tvar interprosAppellation = interprosGenre;\n        \t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].hasOwnProperty(\"interpro\"))\n        \t\t{\n        \t\t\tnb = 0;\n        \t\t\tfor (item in doc.declaration.certifications[certification].genres[genre].appellations[appellation].interpro) {\n        \t\t\t\tnb = nb + 1;\n        \t\t\t}\n        \t\t\tif (nb > 0) {\n\t        \t\t\tinterprosAppellation = new Array();\n\t\t            \tfor (i in doc.declaration.certifications[certification].genres[genre].appellations[appellation].interpro)\n\t\t            \t{\n\t\t            \t\tinterprosAppellation[i] = new Array();\n\t\t            \t\tinterprosAppellation[i][\"label\"] = new Array();\n\t\t            \t\tinterprosAppellation[i][\"douane\"] = new Array();\n\t\t            \t\tinterprosAppellation[i][\"cvo\"] = new Array();\n\t\t            \t\tif (interprosGenre.hasOwnProperty(i))\n\t\t            \t\t{\n\t\t            \t\t\tinterprosAppellation[i][\"label\"] = interprosGenre[i][\"label\"];\n\t\t            \t\t\tinterprosAppellation[i][\"douane\"] = interprosGenre[i][\"douane\"];\n\t\t            \t\t\tinterprosAppellation[i][\"cvo\"] = interprosGenre[i][\"cvo\"];\n\t\t            \t\t}\n\t\t            \t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].interpro[i].labels.length > 0)\n\t\t            \t\t{\n\t\t\t        \t\t\tinterprosAppellation[i][\"label\"] = doc.declaration.certifications[certification].genres[genre].appellations[appellation].interpro[i].labels;\n\t\t            \t\t}\n\t\t            \t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].interpro[i].hasOwnProperty(\"droits\"))\n\t\t            \t\t{\n\t\t            \t\t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].interpro[i].droits.hasOwnProperty(\"douane\") && doc.declaration.certifications[certification].genres[genre].appellations[appellation].interpro[i].droits.douane.length > 0)\n\t\t            \t\t\t\tinterprosAppellation[i][\"douane\"] = doc.declaration.certifications[certification].genres[genre].appellations[appellation].interpro[i].droits.douane.pop();\n\t\t            \t\t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].interpro[i].droits.hasOwnProperty(\"cvo\") && doc.declaration.certifications[certification].genres[genre].appellations[appellation].interpro[i].droits.cvo.length > 0)\n\t\t            \t\t\t\tinterprosAppellation[i][\"cvo\"] = doc.declaration.certifications[certification].genres[genre].appellations[appellation].interpro[i].droits.cvo.pop();\n\t\t            \t\t}\n\t\t            \t}\n        \t\t\t}\n        \t\t}\n        \t\tif (departementsAppellation.length == 0)\n        \t\t{\n        \t\t\tdepartementsAppellation = departementsGenre;\n        \t\t}\n        \t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].hasOwnProperty('detail'))\n        \t\t{\n        \t\t\tdetailAppellation = doc.declaration.certifications[certification].genres[genre].appellations[appellation].detail;\n        \t\t}\n        \t\tfor(mention in doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions) \n        \t\t{\n        \t\t\tvar mentionLibelle = doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].libelle;\n        \t\t\tvar departementsMention = doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].departements;\n        \t\t\tvar detailMention = detailAppellation;\n        \t\t\tvar interprosMention = interprosAppellation;\n        \t\t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].hasOwnProperty(\"interpro\"))\n        \t\t\t{\n        \t\t\t\tnb = 0;\n        \t\t\t\tfor (item in doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].interpro) {\n        \t\t\t\t\tnb = nb + 1;\n        \t\t\t\t}\n        \t\t\t\tif (nb > 0)\n        \t\t\t\t{\n        \t\t    \t\tinterprosMention = new Array();\n        \t\t        \tfor (i in doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].interpro)\n        \t\t        \t{\n        \t\t        \t\tinterprosMention[i] = new Array();\n        \t\t        \t\tinterprosMention[i][\"label\"] = new Array();\n        \t\t        \t\tinterprosMention[i][\"douane\"] = new Array();\n        \t\t        \t\tinterprosMention[i][\"cvo\"] = new Array();\n        \t\t        \t\tif (interprosAppellation.hasOwnProperty(i))\n        \t\t        \t\t{\n        \t\t        \t\t\tinterprosMention[i][\"label\"] = interprosAppellation[i][\"label\"];\n        \t\t        \t\t\tinterprosMention[i][\"douane\"] = interprosAppellation[i][\"douane\"];\n        \t\t        \t\t\tinterprosMention[i][\"cvo\"] = interprosAppellation[i][\"cvo\"];\n        \t\t        \t\t}\n        \t\t        \t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].interpro[i].labels.length > 0)\n        \t\t        \t\t{\n        \t\t        \t\t\tinterprosMention[i][\"label\"] = doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].interpro[i].labels;\n        \t\t        \t\t}\n        \t\t        \t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].interpro[i].hasOwnProperty(\"droits\"))\n        \t\t        \t\t{\n        \t\t        \t\t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].interpro[i].droits.hasOwnProperty(\"douane\") && doc.declaration.certifications[certification].genres[genre].appellations[appellation].lieux[lieu].interpro[i].droits.douane.length > 0)\n        \t\t        \t\t\t\tinterprosMention[i][\"douane\"] = doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].interpro[i].droits.douane.pop();\n        \t\t        \t\t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].interpro[i].droits.hasOwnProperty(\"cvo\") && doc.declaration.certifications[certification].genres[genre].appellations[appellation].lieux[lieu].interpro[i].droits.cvo.length > 0)\n        \t\t        \t\t\t\tinterprosMention[i][\"cvo\"] = doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].interpro[i].droits.cvo.pop();\n        \t\t        \t\t}\n        \t\t        \t}\n        \t\t\t\t}\n        \t\t\t}\n        \t\t\tif (departementsMention.length == 0)\n        \t\t\t{\n        \t\t\t\tdepartementsMention = departementsAppellation;\n        \t\t\t}\n        \t\t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].hasOwnProperty('detail'))\n        \t\t\t{\n        \t\t\t\tdetailLieu = doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].detail;\n        \t\t\t} // END\n\t    \t\t\tfor(lieu in doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux) \n\t    \t\t\t{\n\t    \t\t\t\tvar lieuLibelle = doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].libelle;\n\t            \t\tvar departementsLieu = doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].departements;\n\t            \t\tvar detailLieu = detailMention;\n\t            \t\tvar interprosLieu = interprosMention;\n\t            \t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].hasOwnProperty(\"interpro\"))\n\t            \t\t{\n\t            \t\t\tnb = 0;\n\t            \t\t\tfor (item in doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].interpro) {\n\t            \t\t\t\tnb = nb + 1;\n\t            \t\t\t}\n\t            \t\t\tif (nb > 0)\n\t            \t\t\t{\n\t\t                \t\tinterprosLieu = new Array();\n\t\t\t                \tfor (i in doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].interpro)\n\t\t\t                \t{\n\t\t\t                \t\tinterprosLieu[i] = new Array();\n\t\t\t                \t\tinterprosLieu[i][\"label\"] = new Array();\n\t\t\t                \t\tinterprosLieu[i][\"douane\"] = new Array();\n\t\t\t                \t\tinterprosLieu[i][\"cvo\"] = new Array();\n\t\t\t                \t\tif (interprosMention.hasOwnProperty(i))\n\t\t\t                \t\t{\n\t\t\t                \t\t\tinterprosLieu[i][\"label\"] = interprosMention[i][\"label\"];\n\t\t\t                \t\t\tinterprosLieu[i][\"douane\"] = interprosMention[i][\"douane\"];\n\t\t\t                \t\t\tinterprosLieu[i][\"cvo\"] = interprosMention[i][\"cvo\"];\n\t\t\t                \t\t}\n\t\t\t                \t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].interpro[i].labels.length > 0)\n\t\t\t                \t\t{\n\t\t\t\t\t        \t\t\tinterprosLieu[i][\"label\"] = doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].interpro[i].labels;\n\t\t\t                \t\t}\n\t\t\t                \t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].interpro[i].hasOwnProperty(\"droits\"))\n\t\t\t                \t\t{\n\t\t\t\t            \t\t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].interpro[i].droits.hasOwnProperty(\"douane\") && doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].interpro[i].droits.douane.length > 0)\n\t\t\t\t            \t\t\t\tinterprosLieu[i][\"douane\"] = doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].interpro[i].droits.douane.pop();\n\t\t\t\t            \t\t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].interpro[i].droits.hasOwnProperty(\"cvo\") && doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].interpro[i].droits.cvo.length > 0)\n\t\t\t\t            \t\t\t\tinterprosLieu[i][\"cvo\"] = doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].interpro[i].droits.cvo.pop();\n\t\t\t                \t\t}\n\t\t\t                \t}\n\t            \t\t\t}\n\t            \t\t}\n\t            \t\tif (departementsLieu.length == 0)\n\t            \t\t{\n\t            \t\t\tdepartementsLieu = departementsMention;\n\t            \t\t}\n\t            \t\tif (doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].hasOwnProperty('detail'))\n\t            \t\t{\n\t            \t\t\tdetailLieu = doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].detail;\n\t            \t\t}\n\t    \t\t\t\t\n\t    \t\t\t\tfor(couleur in doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].couleurs) \n\t    \t\t\t\t{\n\t    \t\t\t\t\tvar couleurLibelle = doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].couleurs[couleur].libelle;\n\t    \t\t\t\t\t\n\t    \t\t\t\t\tfor(cepage in doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].couleurs[couleur].cepages) \n\t    \t\t\t\t\t{    \n\t    \t\t\t\t\t\tvar cepageLibelle = doc.declaration.certifications[certification].genres[genre].appellations[appellation].mentions[mention].lieux[lieu].couleurs[couleur].cepages[cepage].libelle;\n\t    \t\t\t\t\t\tvar hash = \"declaration/certifications/\"+certification+\"/genres/\"+genre+\"/appellations/\"+appellation+\"/mentions/\"+mention+\"/lieux/\"+lieu+\"/couleurs/\"+couleur+\"/cepages/\"+cepage;\n\t    \t\t\t\t\t\t\n\t    \t\t\t\t\t\tfor(i in interprosLieu)\n\t    \t\t\t\t\t\t{\n\t    \t\t\t\t\t\t\temit([i, certificationLibelle, genreLibelle, appellationLibelle, mentionLibelle, lieuLibelle, couleurLibelle, cepageLibelle, hash], {\"departements\": departementsLieu, \"douane\": interprosLieu[i][\"douane\"], \"cvo\": interprosLieu[i][\"cvo\"], \"labels\": interprosLieu[i][\"label\"], \"entrees\": {\"repli\": detailLieu.entrees.repli.readable, \"declassement\": detailLieu.entrees.declassement.readable}, \"sorties\": {\"repli\": detailLieu.sorties.repli.readable, \"declassement\": detailLieu.sorties.declassement.readable}});\n\t    \t\t\t\t\t\t}\n\t    \t\t\t\t\t}\n\t    \t\t\t\t}\n\t    \t\t\t}\n    \t\t\t}\n    \t\t}\n        }\n    }\n}"
       }
    }
}
EOF

curl -s -X PUT -d "@$TMPFILE" $COUCHDBURL/_design/$design

curl -s $COUCHDBURL/_design/$design/_view/all > /dev/null &
sleep 1
kill %1

design=etablissement
curl -s -X DELETE "$COUCHDBURL/_design/$design?rev=$(curl --stderr /dev/null $COUCHDBURL/_design/$design | sed 's/.*_rev":"//' | sed 's/",".*//' 2> /dev/null)" > /dev/null 2>&1

cat <<EOF > $TMPFILE
{
   "_id": "_design/etablissement",
   "language": "javascript",
   "views": {
   "all": {
       "map": "function(doc) {\n  if (doc.type == \"Etablissement\") {\n  emit([doc.interpro, doc._id, doc.nom, doc.identifiant, doc.raison_sociale, doc.siret, doc.cvi, doc.siege.commune, doc.siege.code_postal], null);\n }\n}"
        }
    }
}
EOF

curl -s -X PUT -d "@$TMPFILE" $COUCHDBURL/_design/$design

curl -s $COUCHDBURL/_design/$design/_view/all > /dev/null &
sleep 1
kill %1