#!/bin/bash

#. bin/download_redmine_file https://clients.actualys.com/attachments/download/3559/CIVP_Data.zip /tmp/CIVP_Data.zip
SYMFODIR=$(pwd);
{
mkdir /tmp/CIVP_DATA 2> /dev/null ; cd  /tmp/CIVP_DATA ; rm -rf * 2>/dev/null
unzip /tmp/CIVP_Data.zip

cd CIVP_Data
DATADIR=$(pwd);
if false ; then
    echo "Import des Ã©tablissements";
    
    recode ISO88591..UTF8 etablissement.csv
    cat etablissement.csv | sed 's/^\([^;]*;[^;]*;[^;]*;[^;]*;[^;]*;[^;]*;[^;]*;[^;]*;[^;]*;[^;]*;[^;]*;[^;]*;[^;]*;\)/\1;/' | sed 's/nom;;RaisonSociale/nom;RaisonSociale/' > etablissement.csv.tmp
    mv etablissement.csv.tmp etablissement.csv
    curl -s -c /tmp/cookie.txt http://autologin:bonjour@declaration.dev.declarvin.com/edi.php/edi/etablissements/csv > /dev/null
    curl -s -L -b /tmp/cookie.txt -X POST -u autologin:bonjour -F "csv[file]=@etablissement.csv"  "http://declaration.dev.declarvin.com/edi.php/edi/etablissements/csv?id=INTERPRO-civp"
    echo
fi

if false ; then
    
    echo "Import des DRM";
    
    DRM="DRm export.csv"
    recode ISO88591..UTF8 "$DRM"
    cp "$DRM" "$DRM.orig"
    
    cat "$DRM.orig" | sed 's|\([0-9][0-9]\)/\([0-9][0-9]\)/\([0-9][0-9][0-9][0-9]\)|\3-\2-\1;\3-\2-\1|' | sed 's/,/./g' | sed 's/2088;11/2008;11/' | sed 's/2066;9/2006;9/' | sed 's/\r//' > "$DRM.1.tmp"
    cat "$DRM.1.tmp" | sed 's/;VDP;83;VDP83/;VDP;Var;VDP83/' | grep -v "CAP; *; *;Blanc;1"  > "$DRM.2.tmp"
    cat "$DRM.2.tmp" | awk -F ';' '{ZERO = "" ; if ($5 < 10) ZERO = "0" ; print $1";"$2";"$3"___"$4"___"ZERO $5";"$6";"$7";"$8";"$9";"$10";"$11";"$12";"$13";"$14";"$15";"$16";"$17";"$18";"$19";"$20";"$21";"$22";"$23";"$24";"$25";"$26";"$27";0;0;0;0;"$33+$34+$35+$36+$37+$38";"$33";"$34";"$35";"$36";"$37";"$38";"$40+$41+$42+$43+$44+$45+$46+$47+$48+$49+$50";"$40";"$41";"$42";"$43";"$44";"$45";"$46";"$47";"$48";"$49";"$50";"$27+$33+$34+$35+$36+$37+$38-$40-$41-$42-$43-$44-$45-$46-$47-$48-$49-$50";0;0;0;0;"$56";"$57";"$58";"$59";"$60";"$61";"$62";"}' | sort -t ';' -k 3  > "$DRM.3.tmp"
    cat "$DRM.3.tmp" | sed 's/___/;/g' > "$DRM.4.tmp"
    cp "$DRM.4.tmp" "$DRM"
    
    rm *tmp *orig;
    cd $SYMFODIR
    php symfony import:DRM --file="$DATADIR/$DRM"
    
    cd -
fi

echo "Import des contrats vracs"

VRAC="export contrat vrac.csv"
recode ISO88591..UTF8 "$VRAC"
cat "$VRAC" | sed 's/[^0-9]*$/;/g' > "$VRAC.1.tmp"

}
